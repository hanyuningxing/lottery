BIG_SMALL_ARR = [ '大大大', '大大小', '大小大', '小大大', '小小大', '小大小', '大小小', '小小小' ];
ODD_EVEN_ARR = [ '偶偶偶', '偶偶奇', '偶奇偶', '奇偶偶', '奇奇偶', '奇偶奇', '偶奇奇', '奇奇奇' ];
ZHI_HE_ARR = [ '质质质', '质质合', '质合质', '合质质', '合合质', '合质合', '质合合', '合合合' ];



BIG_SMALL_ARR_NAME = [ 'bbb', 'bbs', 'bsb', 'sbb', 'ssb', 'sbs', 'bss', 'sss' ];
ODD_EVEN_ARR_NAME = [ 'ooo', 'ooj', 'ojo', 'joo', 'jjo', 'joj', 'ojj', 'jjj' ];
ZHI_HE_ARR_NAME = [ 'zzz', 'zzh', 'zhz', 'hzz', 'hhz', 'hzh', 'zhh', 'hhh' ];



TAB_HEADER = '<table width="100%" border="0" cellpadding="0" cellspacing="1" class="zstablegraybg" ><tr class="trtitlebg"><td width="60" rowspan="2">@SELECT@</td><td rowspan="2"  > 出号</td><td class="b1redpx">全 大</td><td colspan="3" >两大一小</td><td colspan="3" >两小一大</td><td > 全 小</td><td class="b1redpx">全 偶</td><td colspan="3" >两偶一奇</td><td colspan="3" >两奇一偶 </td><td >全 奇</td><td class="b1redpx">全 合</td><td colspan="3" >两合一质</td><td colspan="3" >两质一合 </td><td >全 质</td><td width="30" rowspan="2" class="b1redpx">和值</td></tr><tr class="zsttrpinklig"><td width="43" class="b1redpx">大大大</td><td width="43" >大大小</td><td width="43" >大小大</td><td width="43">小大大</td><td width="43" >小小大</td><td width="43" >小大小</td><td width="43" >大小小</td><td width="43" >小小小</td><td width="43" class="b1redpx">偶偶偶</td><td width="43" >偶偶奇</td><td width="43" >偶奇偶</td><td width="43">奇偶偶</td><td width="43" >奇奇偶</td><td width="43">奇偶奇</td><td width="43" >偶奇奇</td><td width="43" >奇奇奇 </td><td width="43" class="b1redpx">合合合</td><td width="43" >合合质</td><td width="43" >合质合</td><td width="43">质合合</td><td width="43" >质质合</td><td width="43">质合质</td><td width="43" >合质质</td><td width="43" >质质质 </td></tr>';
TAB_FOOTER = '<tr class="trtitlebg"><td rowspan="2" class="zsttrpink">@SELECT@</td><td rowspan="2" class=" zsttrpink" >出号</td><td class="b1redpx zsttrpinklig">大大大</td><td class="zsttrpinklig">大大小</td><td  class="zsttrpinklig">大小大</td><td  class="zsttrpinklig">小大大</td><td  class="zsttrpinklig">小小大</td><td  class="zsttrpinklig">小大小</td><td  class="zsttrpinklig">大小小</td><td  class="zsttrpinklig">小小小</td><td  class="zsttrpinklig">偶偶偶</td><td  class="zsttrpinklig">偶偶奇</td><td  class="zsttrpinklig">偶奇偶</td><td  class="zsttrpinklig">奇偶偶</td><td  class="zsttrpinklig">奇奇偶</td><td  class="zsttrpinklig">奇偶奇</td><td  class="zsttrpinklig">偶奇奇</td><td  class="zsttrpinklig">奇奇奇 </td><td width="43"  class="zsttrpinklig">合合合</td><td width="43"  class="zsttrpinklig">合合质</td><td width="43"  class="zsttrpinklig">合质合</td><td width="43"  class="zsttrpinklig">质合合</td><td width="43"  class="zsttrpinklig">质质合</td><td width="43"  class="zsttrpinklig">质合质</td><td width="43"  class="zsttrpinklig">合质质</td><td width="43"  class="zsttrpinklig">质质质 </td><td rowspan="2" class=" b1redpx zsttrpink">和值</td></tr><tr class="trtitlebg"><td class="b1redpx">全 大</td><td colspan="3" >两大一小</td><td colspan="3" >两小一大</td><td > 全 小</td><td class="b1redpx">全 偶</td><td colspan="3" >两偶一奇</td><td colspan="3" >两奇一偶 </td><td >全 奇</td><td class="b1redpx">全 合</td><td colspan="3" >两合一质</td><td colspan="3" >两质一合 </td><td >全 质</td></tr></table>';
MONI_SELECT = '<td class="trgray graychar333">模拟选号</td><td>&nbsp;</td><td class="b1redpx" style="cursor:pointer" onclick="dxjo_click(this);">大大大</td><td style="cursor:pointer" onclick="dxjo_click(this);">大大小</td><td style="cursor:pointer" onclick="dxjo_click(this);">大小大</td><td style="cursor:pointer" onclick="dxjo_click(this);">小大大</td><td style="cursor:pointer" onclick="dxjo_click(this);">小小大</td><td style="cursor:pointer" onclick="dxjo_click(this);">小大小</td><td style="cursor:pointer" onclick="dxjo_click(this);">大小小</td><td style="cursor:pointer" onclick="dxjo_click(this);">小小小</td><td class="b1redpx" style="cursor:pointer" onclick="dxjo_click(this);">偶偶偶</td><td style="cursor:pointer" onclick="dxjo_click(this);">偶偶奇</td><td style="cursor:pointer" onclick="dxjo_click(this);">偶奇偶</td><td style="cursor:pointer" onclick="dxjo_click(this);">奇偶偶</td><td style="cursor:pointer" onclick="dxjo_click(this);">奇奇偶</td><td style="cursor:pointer" onclick="dxjo_click(this);">奇偶奇</td><td style="cursor:pointer" onclick="dxjo_click(this);">偶奇奇</td><td style="cursor:pointer" onclick="dxjo_click(this);">奇奇奇 </td><td class="b1redpx" style="cursor:pointer" onclick="dxjo_click(this);">合合合</td><td style="cursor:pointer" onclick="dxjo_click(this);">合合质</td><td style="cursor:pointer" onclick="dxjo_click(this);">合质合</td><td style="cursor:pointer" onclick="dxjo_click(this);">质合合</td><td style="cursor:pointer" onclick="dxjo_click(this);">质质合</td><td style="cursor:pointer" onclick="dxjo_click(this);">质合质</td><td style="cursor:pointer" onclick="dxjo_click(this);">合质质</td><td style="cursor:pointer" onclick="dxjo_click(this);">质质质 </td><td class="b1redpx">&nbsp;</td>';
function getDrawedData() {
	return pl3_ball_data;
}

/**
 * 生成开奖结果对象
 * 
 * @param numStr - (<em>string</em>) 开奖结果字符串
 * @param issue - (<em>string</em>) 期号
 * @param prevResult - (<em>object</em>) 上一期开奖结果对象
 * @returns {object} - 开奖结果对象
 */
function genResult(numStr, issue, prevResult) {
	var numArr = numStr.split(/[^\d]+/);
	var result = {
		nums : [ numArr[0], numArr[1], numArr[2] ],
		sum : 0
	};
	result.nums.each(function(num, index) {
		var numInt = num.toInt();
		result.sum += numInt;
	});
	return result;
}
function getBigSmallValue(nums) {
	var v = '';
	nums.each(function(num) {
		v += (num.toInt() > 4) ? 'b' : 's';
	});
	return v;
}

function getOddEvenValue(nums) {
	var v = '';
	nums.each(function(num) {
		v += (num.toInt() % 2 == 0) ? 'o' : 'j';
	});
	return v;
}
function getZhiheValue(nums) {
	var v = '';
	nums.each(function(num) {
		v += (1==num||2==num||3==num||5==num||7==num) ? 'z' : 'h';
	});
	return v;
}
/**
 * 计算一期遗漏数据
 * 
 * @param issue - (<em>string</em>) 期号
 * @param result - (<em>object</em>) 开奖结果
 * @param prevMissItem - (<em>object</em>) 上一期的遗漏数据
 * @returns {object} - 该期的遗漏数据
 */
function buildMissItem(issue, result, prevMissItem) {
	var missItem = {
			result : DATA_HASH.get(issue),
			dxMissObj : new Hash(),
			joMissObj : new Hash(),
			zhMissObj : new Hash()
	};
	if (prevMissItem != null) {
		missItem.dxMissObj=prevMissItem.dxMissObj.map(function(value) {
			return value + 1;
		});
		missItem.joMissObj=prevMissItem.joMissObj.map(function(value) {
			return value + 1;
		});
		missItem.zhMissObj=prevMissItem.zhMissObj.map(function(value) {
			return value + 1;
		});
	} else {
		BIG_SMALL_ARR_NAME.each(function(key) {
			missItem.dxMissObj.set(key, 1);
		});
		ODD_EVEN_ARR_NAME.each(function(key) {
			missItem.joMissObj.set(key, 1);
		});
		ZHI_HE_ARR_NAME.each(function(key) {
			missItem.zhMissObj.set(key, 1);
		});
	}
	var bigsmall_v = getBigSmallValue(result.nums);
	var oddeven_v = getOddEvenValue(result.nums);
	var zhihe_v = getZhiheValue(result.nums);
	missItem.dxMissObj.set(bigsmall_v, 0);
	missItem.joMissObj.set(oddeven_v, 0);
	missItem.zhMissObj.set(zhihe_v, 0);
	missItem.html = buildMissItemHTML(issue, missItem);
	return missItem;
}

/**
 * 构建一期遗漏数据的HTML代码
 * 
 * @param issue - (<em>string</em>) 期号
 * @param missItem - (<em>object</em>) 遗漏数据
 * @returns {string} - 遗漏数据的HTML代码
 */
function buildMissItemHTML(issue, missItem) {
	var html = '<td class="graychar333" >' + issue + '</td>';
	html += '<td class="redredbchar">' + missItem.result.nums.join() + '</td>';

	BIG_SMALL_ARR_NAME.each(function(key, index) {
		var miss = missItem.dxMissObj.get(key);
		var classStr = (index == 0) ? 'b1redpx' : '';
		var text;
		if (miss == 0) {
			classStr += ' trchoseo';
			text = '<span _cancas="cancas" _group="bigsmall">' + BIG_SMALL_ARR[index] + '</span>';
		} else {
			text = miss;
		}
		html += '<td class="' + classStr + '">' + text + '</td>';
	});
	ODD_EVEN_ARR_NAME.each(function(key, index) {
		var miss = missItem.joMissObj.get(key);
		var classStr = (index == 0) ? 'b1redpx' : '';
		var text;
		if (miss == 0) {
			classStr += ' trchoseo';
			text = '<span _cancas="cancas" _group="oddeven">' + ODD_EVEN_ARR[index] + '</span>';
		} else {
			text = miss;
		}
		html += '<td class="' + classStr + '">' + text + '</td>';
	});
	
	ZHI_HE_ARR_NAME.each(function(key, index) {
		var miss = missItem.zhMissObj.get(key);
		var classStr = (index == 0) ? 'b1redpx' : '';
		var text;
		if (miss == 0) {
			classStr += ' trchoseo';
			text = '<span _cancas="cancas" _group="zhihe">' + ZHI_HE_ARR[index] + '</span>';
		} else {
			text = miss;
		}
		html += '<td class="' + classStr + '">' + text + '</td>';
	});

	html += '<td class="b1redpx graychar333">' + missItem.result.sum + '</td>';
	return html;
}

/**
 * 生成遗漏数据的HTML代码
 * 
 * @param key - (<em>string</em>) 期号
 * @param checkFn - (<em>function</em>) 检查是否需要统计该期的函数
 *            <ul>
 *            <h3>语法：<code>fn(issue)</code></h3>
 *            <h3>参数：</h3>
 *            <ol>
 *            <li>issue - (<em>string</em>) 期号</li>
 *            </ol>
 *            </ul>
 * @param desc - (<em>boolean</em>) 是否倒序输出
 * @returns {string} - 遗漏数据HTML代码
 */
function genMissHTML(key, checkFn, desc) {
	var missHTML = '';
	var index = 0;
	var issueSize = 0;
	var itemIandleFn = function(issue, missItem) {
		issueSize++;
		missHTML += '<tr class="' + ((index++ % 2 == 0) ? 'trw' : 'trgray') + '">' + missItem.html + '</tr>';
	};
	displayHandle(key, checkFn, desc, itemIandleFn);

	var moniHTML = '';
	for ( var i = 0; i < 1; i++) {
		moniHTML += '<tr class="' + ((index++ % 2 == 0) ? 'trw' : 'trgray') + '">' + MONI_SELECT + '</tr>';
	}

	var selectHTML = getSortSelectHTML(desc);
	var html = TAB_HEADER.replace(/@SELECT@/, selectHTML) + missHTML + moniHTML
			+ TAB_FOOTER.replace(/@SELECT@/, selectHTML);
	return html;
}

// 华丽的分隔线 ======================================================================

/**
 * 初始化历史遗漏数据，将提供的数据，转换成一致的格式存储
 */
function initHistoryMissHash() {
	var data = pl3_dxjozh;
	for ( var issue in pl3_dxjozh) {
		var missObj = {
			dxMissObj : data[issue].bs,
		    joMissObj : data[issue].jo,
			zhMissObj : data[issue].zh
		};
		HISTORY_MISS_HASH.set(issue, buildHistoryMissItem(issue, missObj));
	}
}

/**
 * 构建一期的历史遗漏数据
 * 
 * @param issue - (<em>string</em>) 期号
 * @param missObj - (<em>object</em>) 历史遗漏数据对象
 * @returns {object} - 该期的历史遗漏数据
 */
function buildHistoryMissItem(issue, missObj) {
	var missItem = {
		result : DATA_HASH.get(issue),
		dxMissObj : new Hash(),
	    joMissObj : new Hash(),
		zhMissObj : new Hash()
	};
	for ( var key in missObj.dxMissObj) {
		missItem.dxMissObj.set(key, missObj.dxMissObj[key]);
	}
	for ( var key in missObj.joMissObj) {
		missItem.joMissObj.set(key, missObj.joMissObj[key]);
	}
	for ( var key in missObj.zhMissObj) {
		missItem.zhMissObj.set(key, missObj.zhMissObj[key]);
	}
	
	missItem.html = buildMissItemHTML(issue, missItem);
	return missItem;
};

// 华丽的分隔线 ======================================================================

function drawLine() {
	$("div_line").innerHTML = "";
	[ 'bigsmall', 'oddeven','zhihe' ].each(function(hashName, index) {
		var tagArr1 = $$('span[_cancas="cancas"][_group="' + hashName + '"]');
		var myfun = function() {
			drawCancas(tagArr1, 1);
		};
		myfun.delay(10);
	});
}

function dxjo_click(el) {
	var className = 'trchoseo';
	el = $(el);
	if (el.hasClass(className)) {
		el.removeClass(className);
	} else {
		el.addClass(className);
	}
}