package com.cai310.lottery.fetch.win310;

import java.text.DecimalFormat;
import java.text.NumberFormat;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang.StringUtils;
import org.dom4j.Document;
import org.dom4j.DocumentException;
import org.dom4j.DocumentHelper;
import org.dom4j.Element;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;

import com.cai310.lottery.Constant;
import com.cai310.lottery.common.Lottery;
import com.cai310.lottery.entity.football.LetGoal;
import com.cai310.lottery.entity.lottery.jczq.JczqMatch;
import com.cai310.lottery.entity.lottery.zc.ZcMatch;
import com.cai310.lottery.exception.DataException;
import com.cai310.lottery.service.football.OddsManager;
import com.cai310.utils.DateUtil;
import com.cai310.utils.HttpClientUtil;
import com.cai310.utils.NumUtils;
import com.google.common.collect.Lists;

public abstract class JcFetcher {
     private static Date jczqStartDate = DateUtil.strToDate("2011-08-01","yyyy-MM-dd");
     private static SimpleDateFormat sd = new SimpleDateFormat("yyyyMMdd");
 	 private static final NumberFormat LINEID_NF = new DecimalFormat("000");
 	 protected final transient Logger logger = LoggerFactory.getLogger(this.getClass());
 	 @Autowired
 	 OddsManager oddsManager;
 	 public abstract String getLetGoalSourceUrl();
	 public abstract String getStandardSourceUrl();
	 public abstract String getTotalScoreSourceUrl();
	 public abstract Lottery getLotteryType();
     private Integer getJczqDate(Integer dateNum){
    	 Calendar cal = Calendar.getInstance();
		 cal.setTime(jczqStartDate);
		 cal.add(Calendar.DATE, dateNum);
		 return Integer.valueOf(sd.format(cal.getTime()));
     }
     /**
 	 * 格式时场次序号
 	 * 
 	 * @param lineIdOfDay
 	 *            场次序号
 	 * @return 已格式的场次序号
 	 */
 	public static String formatLineId(int lineIdOfDay) {
 		return LINEID_NF.format(lineIdOfDay);
 	}
     /**
 	 * 组装场次标识
 	 * 
 	 * @param matchDate
 	 *            比赛场次的日期
 	 * @param lineIdOfDay
 	 *            场次序号
 	 * @return 场次标识
 	 */
     private static Long buildMatchKeyInteger(int matchDate, int lineIdOfDay) {
 		return Long.valueOf(matchDate+""+formatLineId(lineIdOfDay));
 	 }
     /**
      * 
      * @param matchNum 如490005
      * @return
     * @throws DataException 
      */
     public Long getMatchKeyInteger(String matchNum) throws DataException{
    	 try{
	    	 if(StringUtils.isNotBlank(matchNum)){
	    		 Integer lineId = Integer.valueOf(matchNum.substring(matchNum.length()-3));
	    		 String dateNum = matchNum.substring(0,matchNum.length()-3);
	    		 Integer matchDate = getJczqDate(Integer.valueOf(dateNum));
	    		 return buildMatchKeyInteger(matchDate,lineId);
	    	 }
    	 }catch(Exception e){
    		 throw new DataException("解析赛事错去");
    	 }
    	 return null;
     }
     public static void main(String[] args) throws DataException, DocumentException {
    	 String xml = "<?xml  version=\"1.0\" encoding=\"utf-8\"?><odds><i>1,491004,3189408,0.78,-0.5,1.08</i><i>3,491004,3179057,1.05,-0.25,0.87</i><i>4,491004,3189511,0.95,-0.25,0.81</i><i>8,491004,3184713,1.05,-0.25,0.875</i><i>24,491004,3183696,1.06,-0.25,0.89</i><i>31,491004,3177456,1.06,-0.25,0.89</i><i>1,491005,3189409,0.90,0.25,0.96</i><i>3,491005,3179058,0.98,0.25,0.93</i><i>4,491005,3189514,0.81,0.25,0.96</i><i>8,491005,3184708,0.975,0.25,0.95</i><i>24,491005,3183695,0.99,0.25,0.96</i><i>31,491005,3177460,1.00,0.25,0.95</i><i>1,491006,3189410,0.82,-0.25,1.04</i><i>3,491006,3179059,0.80,-0.25,1.13</i><i>4,491006,3189519,0.75,-0.25,1.04</i><i>8,491006,3184712,0.80,-0.25,1.15</i><i>24,491006,3183693,0.82,-0.25,1.14</i><i>31,491006,3177458,0.84,-0.25,1.12</i><i>1,491007,3189411,0.81,0.5,1.05</i><i>3,491007,3179060,1.08,0.75,0.84</i><i>4,491007,3189526,0.89,0.5,0.87</i><i>8,491007,3184711,1.10,0.75,0.825</i><i>24,491007,3183692,0.89,0.5,1.06</i><i>31,491007,3177459,1.11,0.75,0.85</i><i>1,491009,3189412,0.82,0.5,1.04</i><i>3,491009,3179061,0.88,0.5,1.04</i><i>4,491009,3189495,0.94,0.5,0.83</i><i>8,491009,3184709,0.875,0.5,1.05</i><i>24,491009,3183694,0.88,0.5,1.07</i><i>31,491009,3177457,0.88,0.5,1.07</i><i>1,491008,3189413,1.06,0.25,0.80</i><i>3,491008,3179062,1.09,0.25,0.83</i><i>4,491008,3189498,0.77,0,1.01</i><i>8,491008,3184715,1.075,0.25,0.85</i><i>24,491008,3183691,1.12,0.25,0.84</i><i>31,491008,3177454,1.09,0.25,0.86</i><i>1,491010,3189414,1.08,0.5,0.78</i><i>3,491010,3179063,0.81,0.25,1.12</i><i>4,491010,3189484,0.81,0.25,0.96</i><i>8,491010,3184710,1.075,0.5,0.85</i><i>24,491010,3183689,1.09,0.5,0.86</i><i>31,491010,3177455,1.09,0.5,0.86</i><i>1,491011,3189415,0.70,1.5,1.16</i><i>3,491011,3179064,0.96,1.75,0.95</i><i>4,491011,3189496,0.93,1.75,0.83</i><i>8,491011,3184714,1.00,1.75,0.925</i><i>24,491011,3183690,1.00,1.75,0.95</i><i>31,491011,3177461,1.01,1.75,0.94</i><i>1,492003,3194016,0.86,0,1.00</i><i>3,492003,3180753,0.86,0,1.05</i><i>8,492003,3186724,0.85,0,1.075</i><i>24,492003,3185234,0.34,0,2.27</i><i>31,492003,3177468,0.86,0,1.08</i><i>1,492002,3189416,1.01,2.5,0.85</i><i>3,492002,3180754,1.06,2.5,0.85</i><i>4,492002,3189575,0.91,2.5,0.86</i><i>8,492002,3186722,1.075,2.5,0.85</i><i>24,492002,3185235,1.05,2.5,0.89</i><i>31,492002,3177465,1.07,2.5,0.87</i><i>1,492005,3189417,0.70,-0.25,1.16</i><i>3,492005,3180755,0.92,0,0.99</i><i>4,492005,3189570,0.75,-0.25,1.04</i><i>8,492005,3186725,0.95,0,0.975</i><i>24,492005,3185239,0.90,0,1.04</i><i>31,492005,3177466,0.92,0,1.02</i><i>1,492004,3189418,0.82,2.5,1.04</i><i>3,492004,3180785,0.91,2.5,1.00</i><i>4,492004,3189568,0.90,2.5,0.86</i><i>8,492004,3186728,0.90,2.5,1.025</i><i>24,492004,3185238,0.91,2.5,1.03</i><i>31,492004,3177463,0.91,2.5,1.03</i><i>1,492007,3189419,0.78,1,1.08</i><i>3,492007,3180756,0.87,1,1.04</i><i>4,492007,3189545,0.84,1,0.92</i><i>8,492007,3186723,0.875,1,1.05</i><i>24,492007,3185236,0.89,1,1.05</i><i>31,492007,3177462,0.89,1,1.05</i><i>1,492006,3189420,1.08,1,0.78</i><i>3,492006,3180757,0.92,0.75,0.99</i><i>4,492006,3189548,0.78,0.75,1.00</i><i>8,492006,3186727,0.925,0.75,1.00</i><i>24,492006,3185240,0.94,0.75,1.00</i><i>31,492006,3177464,0.93,0.75,1.01</i><i>1,492008,3189421,0.86,0.75,1.00</i><i>3,492008,3180758,0.90,0.75,1.01</i><i>4,492008,3189577,0.99,1,0.79</i><i>8,492008,3186721,0.95,0.75,0.975</i><i>24,492008,3185237,0.96,0.75,0.98</i><i>31,492008,3177467,0.94,0.75,1.00</i><i>1,492009,3189422,0.88,-0.25,0.98</i><i>3,492009,3180759,0.87,-0.25,1.04</i><i>4,492009,3189574,0.83,-0.25,0.94</i><i>8,492009,3186726,0.875,-0.25,1.05</i><i>24,492009,3185241,0.88,-0.25,1.06</i><i>31,492009,3177469,0.89,-0.25,1.05</i><i>1,493002,3195528,1.00,0.25,0.82</i><i>3,493002,3183161,1.00,0.25,0.82</i><i>8,493002,3188468,1.00,0.25,0.85</i><i>24,493002,3187071,1.00,0.25,0.84</i><i>31,493002,3177350,0.99,0.25,0.85</i><i>1,493003,3195529,0.88,-0.5,0.94</i><i>3,493003,3183162,0.88,-0.5,0.94</i><i>8,493003,3188469,0.90,-0.5,0.95</i><i>24,493003,3187072,0.86,-0.5,0.98</i><i>31,493003,3177342,0.88,-0.5,0.96</i><i>1,493013,3195530,0.90,0.25,0.92</i><i>3,493013,3183163,0.89,0.25,0.93</i><i>8,493013,3188630,0.875,0.25,0.975</i><i>24,493013,3187073,0.84,0.25,1.00</i><i>31,493013,3177314,0.90,0.25,0.94</i><i>1,493004,3195531,1.18,0.25,0.64</i><i>3,493004,3183164,0.82,0,1.00</i><i>8,493004,3188470,0.80,0,1.05</i><i>24,493004,3187074,0.78,0,1.06</i><i>31,493004,3177348,0.80,0,1.04</i><i>1,493005,3195532,1.08,0,0.74</i><i>3,493005,3183165,1.07,0,0.75</i><i>8,493005,3188471,1.10,0,0.775</i><i>24,493005,3187094,1.05,0,0.79</i><i>31,493005,3177307,1.06,0,0.78</i><i>1,493006,3195533,1.02,0.5,0.80</i><i>3,493006,3183166,1.02,0.5,0.80</i><i>8,493006,3188472,1.025,0.5,0.825</i><i>24,493006,3187075,1.03,0.5,0.81</i><i>31,493006,3177311,1.01,0.5,0.83</i><i>1,493008,3195534,0.90,0.25,0.92</i><i>3,493008,3183167,0.90,0.25,0.92</i><i>8,493008,3188474,0.925,0.25,0.925</i><i>24,493008,3187076,0.92,0.25,0.92</i><i>31,493008,3177315,0.92,0.25,0.92</i><i>1,493007,3195535,0.80,0.5,1.02</i><i>3,493007,3183168,0.80,0.5,1.02</i><i>8,493007,3188473,1.00,0.75,0.85</i><i>24,493007,3187077,0.22,0,2.63</i><i>31,493007,3177304,0.97,0.75,0.87</i><i>1,493010,3195536,0.92,2,0.90</i><i>3,493010,3183169,0.92,2,0.90</i><i>8,493010,3188476,0.95,2,0.90</i><i>24,493010,3187078,0.97,2,0.87</i><i>31,493010,3177347,0.92,2,0.92</i><i>1,493009,3195537,0.95,0.5,0.87</i><i>3,493009,3183170,0.97,0.5,0.85</i><i>8,493009,3188475,0.975,0.5,0.875</i><i>24,493009,3187079,0.98,0.5,0.86</i><i>31,493009,3177308,0.74,0.25,1.11</i><i>1,493011,3195538,0.80,1.25,1.02</i><i>3,493011,3183171,0.81,1.25,1.01</i><i>8,493011,3188477,0.85,1.25,1.00</i><i>24,493011,3187080,0.87,1.25,0.97</i><i>31,493011,3177306,0.87,1.25,0.97</i><i>1,493012,3195539,0.96,0.75,0.86</i><i>3,493012,3183172,0.91,0.75,0.91</i><i>8,493012,3188478,0.975,0.75,0.875</i><i>24,493012,3187081,0.98,0.75,0.86</i><i>31,493012,3177330,1.01,0.75,0.83</i><i>1,493014,3195540,0.78,0,1.04</i><i>3,493014,3193577,0.77,0,1.05</i><i>8,493014,3189691,0.825,0,1.025</i><i>24,493014,3189731,0.37,0,1.88</i><i>31,493014,3189517,0.80,0,1.04</i><i>1,493015,3195541,0.92,0.75,0.90</i><i>3,493015,3183205,0.92,0.75,0.90</i><i>8,493015,3188570,1.00,0.75,0.85</i><i>24,493015,3187421,1.04,0.75,0.80</i><i>31,493015,3177382,0.74,0.5,1.11</i><i>1,493017,3195543,0.80,-0.25,1.02</i><i>3,493017,3183207,0.75,-0.25,1.07</i><i>8,493017,3188571,0.775,-0.25,1.10</i><i>24,493017,3187423,1.01,0,0.83</i><i>31,493017,3177379,0.71,-0.25,1.14</i><i>1,493016,3195542,0.78,1.25,1.04</i><i>3,493016,3183206,0.77,1.25,1.05</i><i>8,493016,3188618,0.75,1.25,1.125</i><i>24,493016,3187422,0.99,1.5,0.85</i><i>31,493016,3177361,0.77,1.25,1.07</i><i>1,493019,3195544,0.88,1.75,0.94</i><i>3,493019,3183208,0.85,1.75,0.97</i><i>8,493019,3188573,0.90,1.75,0.95</i><i>24,493019,3187424,0.87,1.75,0.97</i><i>31,493019,3177365,0.97,1.75,0.87</i><i>1,493018,3195545,0.84,0.5,0.98</i><i>3,493018,3183209,0.88,0.5,0.94</i><i>8,493018,3188572,0.90,0.5,0.95</i><i>24,493018,3187425,0.90,0.5,0.94</i><i>31,493018,3177352,0.87,0.5,0.97</i><i>1,493020,3195546,0.86,-0.25,0.96</i><i>3,493020,3183210,0.88,-0.25,0.94</i><i>8,493020,3188574,0.90,-0.25,0.95</i><i>24,493020,3187426,0.92,-0.25,0.92</i><i>31,493020,3177373,0.90,-0.25,0.94</i><i>1,493021,3195547,0.96,1.5,0.86</i><i>3,493021,3183211,0.97,1.5,0.85</i><i>8,493021,3188575,0.95,1.5,0.90</i><i>24,493021,3187427,0.92,1.5,0.92</i><i>31,493021,3177383,0.94,1.5,0.90</i><i>1,493023,3195548,0.92,-0.5,0.90</i><i>3,493023,3183212,0.93,-0.5,0.89</i><i>8,493023,3188619,0.975,-0.5,0.875</i><i>24,493023,3187555,0.98,-0.5,0.86</i><i>31,493023,3177384,0.99,-0.5,0.85</i><i>1,493022,3195549,0.96,1.25,0.86</i><i>3,493022,3183213,0.97,1.25,0.85</i><i>8,493022,3188576,0.975,1.25,0.875</i><i>24,493022,3187428,0.93,1.25,0.91</i><i>31,493022,3177353,1.01,1.25,0.83</i><i>1,493025,3195550,0.70,0.25,1.12</i><i>3,493025,3183214,1.00,0.5,0.82</i><i>8,493025,3188578,1.025,0.5,0.825</i><i>24,493025,3187429,0.99,0,0.85</i><i>31,493025,3177364,0.75,0.25,1.09</i><i>1,493024,3195551,0.84,1,0.98</i><i>3,493024,3183215,0.85,1,0.97</i><i>8,493024,3188577,0.85,1,1.00</i><i>24,493024,3187430,0.78,1,1.06</i><i>31,493024,3177358,0.85,1,0.99</i><i>1,491001,3194007,0.96,1,0.80</i><i>3,491001,3189173,1.08,1,0.82</i><i>8,491001,3188435,1.05,1,0.80</i><i>24,491001,3188521,1.09,1,0.83</i><i>31,491001,3188422,1.05,1,0.87</i><i>1,492001,3194015,0.86,0.75,0.90</i><i>3,492001,3189180,0.94,0.75,0.95</i><i>8,492001,3188436,0.90,0.75,0.95</i><i>24,492001,3188522,0.92,0.75,1.00</i><i>31,492001,3188423,0.95,0.75,0.97</i><i>1,491017,3185558,1.02,-1,0.74</i><i>3,491017,3181859,1.07,-1,0.81</i><i>8,491017,3181651,1.05,-1,0.80</i><i>24,491017,3181558,1.08,-1,0.84</i><i>31,491017,3181740,1.11,-1,0.82</i><i>1,491012,3194009,0.68,-0.25,1.08</i><i>3,491012,3192141,0.92,0,0.97</i><i>8,491012,3192293,0.90,0,0.95</i><i>24,491012,3192370,1.00,0,0.92</i><i>31,491012,3192351,0.93,0,0.99</i><i>1,491016,3194010,0.88,0,0.88</i><i>3,491016,3192132,0.88,0,1.02</i><i>8,491016,3192294,0.875,0,0.975</i><i>24,491016,3192377,0.93,0,0.99</i><i>31,491016,3192352,0.90,0,1.02</i><i>1,491013,3194011,0.60,0.25,1.16</i><i>3,491013,3192145,1.06,0.5,0.84</i><i>8,491013,3192295,0.975,0.5,0.825</i><i>24,491013,3192371,1.04,0.5,0.88</i><i>31,491013,3192350,1.06,0.5,0.86</i><i>1,492010,3194017,0.78,0,0.98</i><i>3,492010,3192156,0.80,0,1.11</i><i>8,492010,3192298,0.75,0,1.125</i><i>24,492010,3192383,0.78,0,1.16</i><i>31,492010,3192355,0.80,0,1.13</i><i>1,491002,3194008,0.76,0,1.00</i><i>3,491002,3192109,1.08,0.25,0.82</i><i>8,491002,3192291,1.05,0.25,0.80</i><i>24,491002,3192361,1.09,0.25,0.83</i><i>31,491002,3192348,1.06,0.25,0.86</i><i>1,491003,3194012,1.12,0.5,0.64</i><i>3,491003,3192110,0.90,0.25,0.99</i><i>8,491003,3192292,0.875,0.25,0.975</i><i>24,491003,3192369,0.90,0.25,1.02</i><i>31,491003,3192349,0.93,0.25,0.99</i><i>1,491014,3194013,0.86,0,0.90</i><i>3,491014,3192148,0.89,0,1.01</i><i>8,491014,3192296,0.85,0,1.00</i><i>24,491014,3192378,0.89,0,1.03</i><i>31,491014,3192353,0.88,0,1.04</i><i>1,491015,3194014,0.74,0.5,1.02</i><i>3,491015,3192149,1.06,0.75,0.84</i><i>8,491015,3192297,1.025,0.75,0.825</i><i>24,491015,3192379,1.09,0.75,0.83</i><i>31,491015,3192354,1.08,0.75,0.84</i><i>1,493001,3194018,0.94,2,0.88</i><i>3,493001,3190671,0.94,2,0.94</i><i>8,493001,3192658,0.95,2,0.90</i><i>24,493001,3189752,0.80,1.75,1.13</i><i>31,493001,3189656,1.00,2,0.92</i><i>1,492011,3195527,0.66,-0.5,1.16</i><i>3,492011,3193893,0.99,-0.25,0.90</i><i>8,492011,3193915,1.00,-0.25,0.85</i><i>24,492011,3195020,1.03,-0.25,0.89</i><i>31,492011,3193794,1.02,-0.25,0.90</i></odds>";
    	 Document doc=DocumentHelper.parseText(xml.trim());
    	 JczqFetcher jczqFetcher = new JczqFetcher();
    	 System.out.print(jczqFetcher.getLetGoalData());
	 }
     protected List<LetGoal> getLetGoalData(){
    	String oddsReturn = HttpClientUtil.getRemoteSource(getLetGoalSourceUrl(), Constant.DEFAULT_ENCODE);
  		List<LetGoal> list = Lists.newArrayList();
  		if(StringUtils.isBlank(oddsReturn)){
  			//保存在数据库
  			this.logger.warn("网址请求失败，目标网址：[{}].", getLetGoalSourceUrl());
  		}
    	try {
    		this.logger.debug(oddsReturn);
    		oddsReturn = oddsReturn.substring(oddsReturn.indexOf("<odds>"));
    		
  			Document doc=DocumentHelper.parseText(oddsReturn.trim());
  			Element root = doc.getRootElement();
  			Element ticketElement;
  			Map<Long,JczqMatch> matchMap = oddsManager.getJczqMatchMap();
  			JczqMatch jczqMatch = null;
  			for (Iterator i = root.elementIterator("i"); i.hasNext();) {
  				Element oddsElement = (Element) i.next();
  				String odds = oddsElement.getText();
  				Long matchKey = null;
  				if(StringUtils.isNotBlank(odds)){
  					try {
	  					odds = odds.trim();
	  					String[] oddsArr = odds.split(",");
	  					LetGoal letGoal =new LetGoal();
	  					letGoal.setCompanyId(oddsManager.getCompanyByWin310(Long.valueOf(oddsArr[0])));
	  					matchKey = getMatchKeyInteger(oddsArr[1].trim());
	  					jczqMatch = matchMap.get(matchKey);
	  					letGoal.setLotteryType(getLotteryType());
	  					letGoal.setMatchId(jczqMatch.getId());
	  					letGoal.setUpOdds(NumUtils.createFloat(oddsArr[3]));
	  					letGoal.setGoal(NumUtils.createFloat(oddsArr[4]));
	  					letGoal.setDownOdds(NumUtils.createFloat(oddsArr[5]));
	  					list.add(letGoal);
  					} catch (Exception e) {
  			  			//保存在数据库
  			  			this.logger.warn("解析网址失败，场次Id：[{}].", matchKey);
  			  		}
  				}
  			}
  		} catch (Exception e) {
  			//保存在数据库
  			this.logger.warn("解析网址失败，目标网址：[{}].", getLetGoalSourceUrl());
  		}
    	return list;
     }
}
